<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>New Post</title>

      <link rel="icon" href="/favicon.ico" />
      <link rel="stylesheet" href="../styles/output.css" />
      <link
         rel="stylesheet"
         href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
         integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
         crossorigin="anonymous"
         referrerpolicy="no-referrer" />
      <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />

      <style>
         .tag {
            animation: fadeIn 0.15s ease-in-out;
         }

         @keyframes fadeIn {
            from {
               opacity: 0;
               transform: scale(0.95);
            }
            to {
               opacity: 1;
               transform: scale(1);
            }
         }

         .editor-container {
            background: white;
            padding: 15px;
            border: 1px solid #ddd;
         }

         #editor {
            height: 330px;
            /* margin-top: 10px; */
            border: none;
            font-size: 16px;
         }

         #preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
         }
      </style>
   </head>
   <body class="bg-neutral-100">
      <nav class="relative bg-white border-b border-neutral-200">
         <div class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8">
            <div class="relative flex h-16 items-center justify-between">
               <div class="flex items-center justify-between sm:items-stretch sm:justify-start">
                  <div class="flex shrink-0 items-center">
                     <img src="https://tailwindcss.com/plus-assets/img/logos/mark.svg?color=indigo&shade=500" alt="Your Company" class="h-8 w-auto" />
                     <h1 class="text-gray-900 font-normal ms-2">CREATE<span class="font-bold"> POST</span></h1>
                  </div>
               </div>
               <div class="flex items-center pr-2 sm:static sm:inset-auto sm:ml-6 sm:pr-0">
                  <div class="hidden sm:ml-6 sm:block">
                     <div class="flex space-x-4">
                        <a href="./myblogs.html" class="rounded-md px-3 py-2 text-sm font-medium text-gray-900 hover:bg-white/5 hover:text-sky-700"><i class="fa-solid fa-arrow-left"></i> Back Home</a>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </nav>

      <!-- section create -->
      <section class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8 flex justify-between gap-4">
         <!-- left -->
         <div class="w-[70%] max-h-lvh flex flex-col gap-1 mt-2">
            <div class="w-full flex items-center justify-end text-right text-gray-900 font-medium text-sm">
               <a href="#" class="rounded-md text-neutral-900 px-3 py-2 text-sm font-medium hover:bg-sky-100 hover:text-neutral-600">Edit</a>
               <a href="#" class="rounded-md text-neutral-900 px-3 py-2 text-sm font-medium hover:bg-sky-100 hover:text-neutral-600">Preview</a>
            </div>
            <!-- Form input -->
            <form id="form" class="flex flex-col gap-4">
               <div class="h-[650px] max-w-full px-12 py-7 bg-white rounded-lg border border-neutral-200 overflow-y-auto overflow-hidden flex flex-col gap-4">
                  <!-- cover image -->
                  <img id="preview" class="rounded-lg hidden" />

                  <div class="flex gap-4">
                     <input type="file" name="cover-image" id="cover-image" accept=".jpg, .jpeg, .png, image/jpeg, image/png" hidden />
                     <button
                        id="btn-cover"
                        type="button"
                        onclick="document.getElementById('cover-image').click()"
                        class="inline-flex items-center text-gray-900 hover:bg-neutral-100 box-border pt-3 bg-transparent border border-neutral-300 hover:cursor-pointer font-medium rounded-lg text-sm px-3 py-2 focus:outline-none"
                        data-description="<li>The recommended YouTube banner size is 2560 x 1440 pixels, with a centered safe area for text and logos of 1546 x 423 pixels for visibility on all devices. Ensure the logo and important text are within this safe area, and use JPG or PNG formats.</li> <br> <li>make sure the file size is less than 5 mb</li> <br> <li>use images that do not contain SARA and sexual content</li>">
                        <i class="fa-solid fa-magnifying-glass"></i> Upload Cover Image
                     </button>
                     <button
                        type="button"
                        onclick="document.getElementById('cover-image').click()"
                        class="inline-flex items-center text-gray-900 hover:bg-neutral-100 box-border pt-3 bg-transparent border border-neutral-300 hover:cursor-pointer font-medium rounded-lg text-sm px-3 py-2 focus:outline-none">
                        <i class="fa-solid fa-bolt"></i> Generate Cover Image
                     </button>
                  </div>
                  <div>
                     <input
                        autofocus
                        type="text"
                        name="title"
                        id="title"
                        placeholder="New post title here..."
                        class="text-4xl font-bold text-gray-900 w-full focus:outline-0"
                        required
                        data-description="<li>Think of your post title as a super short (but compelling!) description â€” like an overview of the actual post in one short sentence.</li> <br><li>Use keywords where appropriate to help ensure people can find your post by search.</li>" />
                  </div>

                  <div class="w-full">
                     <div id="tag-container" class="flex flex-wrap items-center gap-2 rounded-lg cursor-text">
                        <input
                           id="tag-input"
                           type="text"
                           placeholder="Add up to max (4 tags)"
                           class="flex-1 min-w-[120px] bg-transparent outline-none text-sm focus:outline-none focus:border-none"
                           data-description="<li>Tags help people find your post - think of them as the topics or categories that best describe your post.</li> <br><li>Add up to four comma-separated tags per post. Use existing tags whenever possible.</li> <br><li>Some tags have special posting guidelines - double check to make sure your post complies with them.</li>" />
                     </div>
                  </div>

                  <div class="editor-container rounded-lg">
                     <!-- editor area -->
                     <div
                        id="editor"
                        data-description="<li>Use Markdown to write and format posts.</li> <li>Commonly used syntax</li> <br><li>Embed rich content such as Tweets, YouTube videos, etc. Use the complete URL: {% embed https://... %}. See a list of supported embeds.</li> <br> <li>In addition to images for the post's content, you can also drag and drop a cover image.</li>"></div>
                  </div>
               </div>
               <div class="flex gap-4 items-center">
                  <button
                     id="btn-pub"
                     type="submit"
                     data-action="publish"
                     name="action"
                     class="btn-post rounded-md bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-sky-700 hover:text-white hover:cursor-pointer"
                     data-description="<li>Ensure your post has a cover image set to make the most of the home feed and social media platforms.</li> <br> <li>Share your post on social media platforms or with your co-workers or local communities.</li> <br> <li>Ask people to leave questions for you in the comments. It's a great way to spark additional discussion describing personally why you wrote it or why people might find it helpful.</li>">
                     Publish
                  </button>
                  <button
                     id="btn-draft"
                     type="submit"
                     data-action="draft"
                     name="action"
                     class="rounded-md px-4 py-2 text-sm font-semibold text-neutral-900 hover:bg-sky-100 hover:text-neutral-600 hover:cursor-pointer"
                     data-description="<li>Ensure your post has a cover image set to make the most of the home feed and social media platforms.</li> <br> <li>Share your post on social media platforms or with your co-workers or local communities.</li> <br> <li>Ask people to leave questions for you in the comments. It's a great way to spark additional discussion describing personally why you wrote it or why people might find it helpful.</li>">
                     Save Draft
                  </button>
                  <a class="rounded-md px-4 py-2 text-lg font-medium text-neutral-900 hover:bg-sky-100 hover:text-neutral-600 hover:cursor-pointer"><i class="fa-solid fa-gear"></i></a>
                  <a href="#" class="rounded-md px-4 py-2 text-sm text-neutral-900 hover:bg-sky-100 hover:text-neutral-600 hover:cursor-pointer">Revert new changes</a>
               </div>
            </form>
         </div>
         <!-- right -->
         <div class="w-[30%] max-h-lvh flex items-center justify-center gap-1 mt-2">
            <div id="rightText" class="opacity-0 translate-y-3 transition-all duration-300 ease-out">
               <div class="w-full flex items-center justify-end text-right text-gray-900 font-medium text-sm">
                  <h3 id="rightTitle" class="text-neutral-900 px-3 py-2 text-xl font-medium"></h3>
               </div>
               <p id="rightDesc" class="text-sm text-gray-600 text-justify px-3 py-2"></p>
            </div>
         </div>
      </section>

      <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>

      <script type="module">
         import { createPosts } from "../api/blogs.js";

         // setup tags input
         const tagsInput = document.getElementById("tag-input");
         const container = document.getElementById("tag-container");

         let tags = [];

         function rederTags() {
            // clear except input
            container.querySelectorAll(".tag").forEach((el) => el.remove());

            tags.forEach((tag, index) => {
               const tagEl = document.createElement("div");
               tagEl.className = "tag flex items-center gap-1 bg-gray-200 px-2 py-1 rounded-md text-sm";

               tagEl.innerHTML = `
               <span># ${tag}</span>
               <button class="ms-1 me-1 font-bold text-red-600 hover:text-red-500 hover:cursor-pointer" data-index="${index}">x</button>`;
               container.insertBefore(tagEl, tagsInput);
            });
         }

         // event if enter after add tag
         tagsInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && tagsInput.value.trim() !== "") {
               e.preventDefault();

               const val = tagsInput.value.trim();

               if (!tags.includes(val)) {
                  tags.push(val);
                  rederTags();
               }
               tagsInput.value = "";
            }

            // backspace delete tags
            if (e.key === "Backspace" && tagsInput.value === "" && tags.length > 0) {
               tags.pop();
               rederTags();
            }

            container.addEventListener("click", (e) => {
               const index = e.target.dataset.index;
               if (index !== undefined) {
                  tags.splice(index, 1);
                  rederTags();
               }
               tagsInput.focus();
            });
         });

         // setup quill form
         const quill = new Quill("#editor", {
            theme: "snow",
            placeholder: "Write your post content here...",
         });

         // setup cover image preview
         const fileImage = document.querySelector("#cover-image");
         const preview = document.getElementById("preview");

         fileImage.addEventListener("change", function () {
            const file = fileImage.files[0];
            const allowedFile = ["image/jpeg", "image/png"];

            if (file && !allowedFile.includes(file.type)) {
               alert("Only JPEG and PNG files are allowed");
               return (this.value = "");
            }

            const blobUrl = URL.createObjectURL(file);
            preview.src = blobUrl;

            preview.classList.remove("hidden");
            // Optional: free memory kalau perlu
            preview.onload = () => URL.revokeObjectURL(blobUrl);
         });

         // setup hover suggestion
         const inputsForm = document.querySelectorAll("#btn-cover, #title, #tag-input, #editor, #btn-pub, #btn-draft");
         const rightBox = document.getElementById("rightText");
         const rightTitle = document.getElementById("rightTitle");
         const rightDesc = document.getElementById("rightDesc");
         const labelMap = {
            "btn-cover": "Upload Cover Tips",
            title: "Writing a Great Post Title",
            "tag-input": "Tagging Guidlines",
            editor: "Editor Basics",
            "btn-pub": "Publishing Tips",
            "btn-draft": "Publishing Tips",
         };

         inputsForm.forEach((input) => {
            input.addEventListener("mouseover", () => {
               const desc = input.dataset.description;
               const titleFocus = labelMap[input.id];

               // Fade-out dulu biar smooth
               rightBox.classList.add("opacity-0", "translate-y-3");

               setTimeout(() => {
                  rightTitle.textContent = titleFocus;
                  rightDesc.innerHTML = desc;

                  // Fade-in
                  rightBox.classList.remove("opacity-0", "translate-y-3");
                  rightBox.classList.add("opacity-100", "translate-y-0");
               }, 250); // jeda dikit biar smooth switching
            });

            input.addEventListener("blur", () => {
               // kalau mau tetap tampil setelah blur, hapus bagian ini
               rightBox.classList.add("opacity-0", "translate-y-3");
            });
         });

         // form actions
         const form = document.getElementById("form");

         // debug form input
         // form.addEventListener("submit", (e) => {
         //    e.preventDefault();
         //    console.log("=== DEBUG MODE ===");
         //    console.log("Raw event:", e);
         //    console.log("Submitter:", e.submitter);
         //    console.log("-----------------------");

         //    console.log("File:", fileImage.files[0]);
         //    console.log("quill:", quill.root.innerHTML);
         //    console.log("Tags:", tags);

         //    if (tags.length === 0) return alert("Tags not found, add minimal 1 tag");

         //    if (quill.root.innerHTML === "<p><br></p>") return alert("Your content must be write something");

         //    const clickButton = e.submitter.dataset.action;
         //    const publish = clickButton === "publish" ? new Date() : null;
         //    const status = clickButton === "publish" ? "published" : "draft";
         //    console.log(publish.toISOString(), status);
         // });
         //

         form.addEventListener("submit", async (e) => {
            e.preventDefault();

            try {
               const title = document.getElementById("title").value;
               const coverImage = fileImage.files[0];
               const category = tags?.[0] ?? null; // category take value of tags index 0
               const content = quill.root.innerHTML;

               if (tags.length === 0) return alert("Tags not found, add minimal 1 tag");
               if (tags.length === 5) return alert("Tagging maximal 4 tag");

               if (quill.root.innerHTML === "<p><br></p>") return alert("Your content must be write something");

               const clickButton = e.submitter.dataset.action;
               const publish = clickButton === "publish" ? new Date().toISOString() : null;
               const status = clickButton === "publish" ? "published" : "draft";

               const res = await createPosts(title, content, coverImage, tags, category, status, publish);

               alert(res.ok ? "Success" : res.message);

               setTimeout(() => {
                  window.location.href = "./dashboard.html";
               }, 350);
            } catch (err) {
               console.error("Form submitter error: ", err.message);
               alert("Error: " + err.message);
            }
         });
      </script>
   </body>
</html>
