<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>New Post</title>

      <link rel="icon" href="/favicon.ico" />
      <link rel="stylesheet" href="../styles/output.css" />
      <link
         rel="stylesheet"
         href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
         integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
         crossorigin="anonymous"
         referrerpolicy="no-referrer" />
      <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />

      <style>
         .tag {
            animation: fadeIn 0.15s ease-in-out;
         }

         @keyframes fadeIn {
            from {
               opacity: 0;
               transform: scale(0.95);
            }
            to {
               opacity: 1;
               transform: scale(1);
            }
         }

         .editor-container {
            background: white;
            padding: 15px;
            border: 1px solid #ddd;
         }

         #editor {
            height: 330px;
            /* margin-top: 10px; */
            border: none;
            font-size: 16px;
         }

         #preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
         }
      </style>
   </head>
   <body class="bg-neutral-100">
      <nav class="relative bg-white border-b border-neutral-200">
         <div class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8">
            <div class="relative flex h-16 items-center justify-between">
               <div class="flex items-center justify-between sm:items-stretch sm:justify-start">
                  <div class="flex shrink-0 items-center">
                     <img src="https://tailwindcss.com/plus-assets/img/logos/mark.svg?color=indigo&shade=500" alt="Your Company" class="h-8 w-auto" />
                     <h1 class="text-gray-900 font-normal ms-2">CREATE<span class="font-bold"> POST</span></h1>
                  </div>
               </div>
               <div class="flex items-center pr-2 sm:static sm:inset-auto sm:ml-6 sm:pr-0">
                  <div class="hidden sm:ml-6 sm:block">
                     <div class="flex space-x-4">
                        <a href="dashboard.html" class="rounded-md px-3 py-2 text-sm font-medium text-gray-900 hover:bg-white/5 hover:text-sky-700"><i class="fa-solid fa-arrow-left"></i> Back Home</a>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </nav>

      <!-- section create -->
      <section class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8 flex justify-between">
         <!-- left -->
         <div class="w-[70%] max-h-lvh flex flex-col gap-1 mt-2">
            <div class="w-full flex items-center justify-end text-right text-gray-900 font-medium text-sm">
               <a href="#" class="rounded-md text-neutral-900 px-3 py-2 text-sm font-medium hover:bg-sky-100 hover:text-neutral-600">Edit</a>
               <a href="#" class="rounded-md text-neutral-900 px-3 py-2 text-sm font-medium hover:bg-sky-100 hover:text-neutral-600">Preview</a>
            </div>
            <!-- Form input -->
            <form id="form" class="flex flex-col gap-4">
               <div class="h-[650px] max-w-full px-12 py-7 bg-white rounded-lg border border-neutral-200 overflow-y-auto overflow-hidden flex flex-col gap-4">
                  <!-- cover image -->
                  <img id="preview" class="rounded-lg hidden" />

                  <div class="flex gap-4">
                     <input type="file" name="cover-image" id="cover-image" hidden />
                     <button
                        type="button"
                        onclick="document.getElementById('cover-image').click()"
                        class="inline-flex items-center text-gray-900 hover:bg-neutral-100 box-border pt-3 bg-transparent border border-neutral-300 hover:cursor-pointer font-medium rounded-lg text-sm px-3 py-2 focus:outline-none">
                        <i class="fa-solid fa-magnifying-glass"></i> Upload Cover Image
                     </button>
                     <button
                        type="button"
                        onclick="document.getElementById('cover-image').click()"
                        class="inline-flex items-center text-gray-900 hover:bg-neutral-100 box-border pt-3 bg-transparent border border-neutral-300 hover:cursor-pointer font-medium rounded-lg text-sm px-3 py-2 focus:outline-none">
                        <i class="fa-solid fa-bolt"></i> Generate Cover Image
                     </button>
                  </div>

                  <div>
                     <input autofocus type="text" name="title" id="title" placeholder="New post title here..." class="text-4xl font-bold text-gray-900 w-full focus:outline-0" />
                  </div>

                  <div class="w-full">
                     <div id="tag-container" class="flex flex-wrap items-center gap-2 rounded-lg cursor-text">
                        <input id="tag-input" type="text" placeholder="Add up to 4 tags..." class="flex-1 min-w-[120px] bg-transparent outline-none text-sm focus:outline-none focus:border-none" />
                     </div>
                  </div>

                  <div class="editor-container rounded-lg">
                     <!-- editor area -->
                     <div id="editor"></div>
                  </div>
               </div>
               <div class="flex gap-4 items-center">
                  <button
                     type="submit"
                     data-action="publish"
                     name="action"
                     class="rounded-md bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-sky-700 hover:text-white hover:cursor-pointer">
                     Publish
                  </button>
                  <button
                     type="submit"
                     data-action="draft"
                     name="action"
                     class="rounded-md px-4 py-2 text-sm font-semibold text-neutral-900 hover:bg-sky-100 hover:text-neutral-600 hover:cursor-pointer">
                     Save Draft
                  </button>
                  <a class="rounded-md px-4 py-2 text-lg font-medium text-neutral-900 hover:bg-sky-100 hover:text-neutral-600 hover:cursor-pointer"><i class="fa-solid fa-gear"></i></a>
                  <a href="#" class="rounded-md px-4 py-2 text-sm text-neutral-900 hover:bg-sky-100 hover:text-neutral-600 hover:cursor-pointer">Revert new changes</a>
               </div>
            </form>
         </div>
         <!-- right -->
         <div></div>
      </section>

      <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>

      <script type="module">
         import { createPosts } from "../api/blogs.js";

         // setup tags input
         const tagsInput = document.getElementById("tag-input");
         const container = document.getElementById("tag-container");

         let tags = [];

         function rederTags() {
            // clear except input
            container.querySelectorAll(".tag").forEach((el) => el.remove());

            tags.forEach((tag, index) => {
               const tagEl = document.createElement("div");
               tagEl.className = "tag flex items-center gap-1 bg-gray-200 px-2 py-1 rounded-md text-sm";

               tagEl.innerHTML = `
                  <span># ${tag}</span>
                  <button class="ms-1 me-1 font-bold text-red-600 hover:text-red-500 hover:cursor-pointer" data-index="${index}">x</button>
               `;
               container.insertBefore(tagEl, tagsInput);
            });
         }

         tagsInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && tagsInput.value.trim() !== "") {
               e.preventDefault();

               const val = tagsInput.value.trim();

               if (!tags.includes(val)) {
                  tags.push(val);
                  rederTags();
               }
               tagsInput.value = "";
            }

            // backspace delete tags
            if (e.key === "Backspace" && tagsInput.value === "" && tags.length > 0) {
               tags.pop();
               rederTags();
            }

            container.addEventListener("click", (e) => {
               const index = e.target.dataset.index;
               if (index !== undefined) {
                  tags.splice(index, 1);
                  rederTags();
               }
               tagsInput.focus();
            });
         });

         // setup quill form
         const quill = new Quill("#editor", {
            theme: "snow",
            placeholder: "Write your post content here...",
         });

         // setup cover image preview
         const fileImage = document.querySelector("#cover-image");
         const preview = document.getElementById("preview");

         fileImage.addEventListener("change", () => {
            const file = fileImage.files[0];
            if (!file) return;

            const blobUrl = URL.createObjectURL(file);
            preview.src = blobUrl;

            preview.classList.remove("hidden");
            // Optional: free memory kalau perlu
            preview.onload = () => URL.revokeObjectURL(blobUrl);
         });

         // form actions
         const form = document.getElementById("form");

         // debug
         // form.addEventListener("submit", (e) => {
         //    e.preventDefault();
         //    console.log("=== DEBUG MODE ===");
         //    console.log("Raw event:", e);
         //    console.log("Submitter:", e.submitter);

         //    const clickButton = e.submitter.dataset.action;
         //    const publish = clickButton === "publish" ? new Date() : null;
         //    const status = clickButton === "publish" ? "published" : "draft";
         //    console.log(publish.toISOString(), status);
         // });

         form.addEventListener("submit", async (e) => {
            e.preventDefault();

            try {
               const title = document.getElementById("title").value;
               const coverImage = fileImage.files[0];
               const category = tags?.[0] ?? null; // category take value of tags index 0
               const content = quill.root.innerHTML;
               const clickButton = e.submitter.dataset.action;

               const publish = clickButton === "publish" ? new Date().toISOString() : null;
               const status = clickButton === "publish" ? "published" : "draft";

               const res = await createPosts(title, content, coverImage, tags, category, status, publish);

               alert(res.ok ? "Success" : res.message);

               setTimeout(() => {
                  window.location.href = "./dashboard.html";
               }, 350);
            } catch (err) {
               console.error("Form submitter error: ", err.message);
               alert("Error: " + err.message);
            }
         });
      </script>
   </body>
</html>
